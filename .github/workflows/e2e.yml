name: E2E Integration Tests

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*'

jobs:
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install kind
        uses: engineerd/setup-kind@v0.6.2
        with:
          version: 'v0.20.0'

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build operator
        working-directory: operator
        run: |
          go mod download
          make build
          make docker-build

      - name: Make E2E script executable
        run: chmod +x tests/e2e/full-integration.sh

      - name: Start backend service
        working-directory: backend
        run: |
          go mod download
          go build -o /tmp/backend-server ./cmd/server/main.go
          # Start backend listening on all interfaces so kind can access it
          /tmp/backend-server > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid
          sleep 5
          for i in {1..10}; do
            if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend to start... ($i/10)"
            sleep 2
          done
          curl -f http://localhost:8080/api/health || (cat /tmp/backend.log && exit 1)

      - name: Get host IP for kind cluster
        id: host-ip
        run: |
          # Get the IP that Docker containers can use to reach the host
          # Try to get the Docker bridge gateway IP, fallback to default gateway
          if command -v docker &> /dev/null; then
            # Get the gateway IP from Docker bridge network
            HOST_IP=$(docker network inspect bridge --format '{{range .IPAM.Config}}{{.Gateway}}{{end}}' 2>/dev/null || echo "")
          fi
          # Fallback to default gateway if Docker method didn't work
          if [ -z "$HOST_IP" ]; then
            HOST_IP=$(ip route | grep default | awk '{print $3}' | head -1)
          fi
          # Final fallback to host.docker.internal (works on Docker Desktop, might need manual config on Linux)
          if [ -z "$HOST_IP" ]; then
            HOST_IP="host.docker.internal"
          fi
          echo "host-ip=$HOST_IP" >> $GITHUB_OUTPUT
          echo "Host IP for backend: $HOST_IP"

      - name: Run E2E tests
        env:
          BACKEND_URL: http://${{ steps.host-ip.outputs.host-ip }}:8080
        run: |
          # Export backend URL for the script
          export BACKEND_URL=http://${{ steps.host-ip.outputs.host-ip }}:8080
          echo "Using BACKEND_URL: $BACKEND_URL"
          echo "Testing backend connectivity from host..."
          curl -f http://localhost:8080/api/health || echo "Warning: Backend not accessible on localhost"
          ./tests/e2e/full-integration.sh

      - name: Cleanup backend
        if: always()
        run: |
          if [ -f /tmp/backend.pid ]; then
            kill $(cat /tmp/backend.pid) || true
          fi

      - name: Cleanup kind cluster
        if: always()
        run: |
          kind delete cluster --name 0xhub-e2e-test || true

