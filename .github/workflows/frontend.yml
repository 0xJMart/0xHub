name: Frontend CI

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  workflow_dispatch:

jobs:
  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Run tests
        working-directory: frontend
        run: npm test -- --run --reporter=verbose

      - name: Generate coverage report
        working-directory: frontend
        run: npm run test:coverage -- --run 2>&1 | tee coverage-output.txt

      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc python3

      - name: Check coverage threshold
        working-directory: frontend
        run: |
          # Extract coverage from terminal output (format: "All files | XX.XX | ...")
          COVERAGE=$(grep "All files" coverage-output.txt | awk '{print $4}' | head -1 || echo "0")
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            # Fallback: calculate from coverage-final.json if available
            if [ -f coverage/coverage-final.json ]; then
              COVERAGE=$(python3 -c "import json; data = json.load(open('coverage/coverage-final.json')); total = sum(1 for f in data.values() if isinstance(f, dict) and 's' in f for c in f['s'].values() if c > 0); lines = sum(1 for f in data.values() if isinstance(f, dict) and 's' in f for _ in f['s'].values()); print(f'{(total/lines*100):.2f}' if lines > 0 else '0')" 2>/dev/null || echo "0")
            fi
          fi
          echo "Coverage: ${COVERAGE}%"
          THRESHOLD=70
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below threshold of ${THRESHOLD}%"
            exit 1
          fi

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

