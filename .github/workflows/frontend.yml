name: Frontend CI

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  workflow_dispatch:

jobs:
  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Run tests
        working-directory: frontend
        run: npm test -- --run --reporter=verbose

      - name: Generate coverage report
        working-directory: frontend
        run: npm run test:coverage -- --run 2>&1 | tee coverage-output.txt

      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc python3

      - name: Check coverage threshold
        working-directory: frontend
        run: |
          # Extract coverage from terminal output (format: "All files | XX.XX | ...")
          COVERAGE=$(grep "All files" coverage-output.txt | awk '{print $4}' | head -1 || echo "0")
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            # Fallback: calculate from coverage-final.json if available
            if [ -f coverage/coverage-final.json ]; then
              COVERAGE=$(python3 << 'EOF'
import json
import sys
try:
    with open('coverage/coverage-final.json', 'r') as f:
        data = json.load(f)
    total_lines = 0
    covered_lines = 0
    for file_data in data.values():
        if isinstance(file_data, dict) and 's' in file_data:
            statements = file_data['s']
            for count in statements.values():
                if count > 0:
                    covered_lines += 1
                total_lines += 1
    if total_lines > 0:
        pct = (covered_lines / total_lines) * 100
        print(f"{pct:.2f}")
    else:
        print("0")
except Exception as e:
    print("0")
EOF
)
            fi
          fi
          echo "Coverage: ${COVERAGE}%"
          THRESHOLD=70
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below threshold of ${THRESHOLD}%"
            exit 1
          fi

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

