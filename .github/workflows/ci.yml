name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: Go Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/hub-api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Go Test
        run: go test ./...
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.60.1
          working-directory: services/hub-api

  frontend:
    name: Frontend Lint/Test/Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Typecheck
        run: npm run typecheck
      - name: Unit tests
        run: npm run test -- --run
      - name: Build
        run: npm run build

  docker-images:
    name: Build Docker Images
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build hub-api image
        run: docker build -t hub-api:test services/hub-api
      - name: Build frontend image
        run: docker build -t hub-frontend:test frontend

  helm:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Helm lint
        run: helm lint deploy/helm/hub

  container-scan:
    name: Container Vulnerability Scan
    needs: docker-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build hub-api image
        run: docker build -t hub-api:scan services/hub-api
      - name: Build frontend image
        run: docker build -t hub-frontend:scan frontend
      - name: Scan hub-api image
        uses: aquasecurity/trivy-action@v0.28.0
        with:
          image-ref: hub-api:scan
          format: table
          exit-code: "1"
          ignore-unfixed: true
      - name: Scan frontend image
        uses: aquasecurity/trivy-action@v0.28.0
        with:
          image-ref: hub-frontend:scan
          format: table
          exit-code: "1"
          ignore-unfixed: true

